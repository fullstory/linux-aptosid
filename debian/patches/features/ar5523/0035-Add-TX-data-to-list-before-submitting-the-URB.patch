From dd198ca86648353c80cbb87e2cf5859b6b0d37a0 Mon Sep 17 00:00:00 2001
From: Pontus Fuchs <pontus.fuchs@gmail.com>
Date: Tue, 11 Sep 2012 15:48:25 +0200
Subject: [PATCH 35/58] Add TX data to list before submitting the URB

Fixes a race where the completion handler might get called
before tx handler have added it.
---
 ar5523.c |   10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

--- a/drivers/net/wireless/ar5523.c
+++ b/drivers/net/wireless/ar5523.c
@@ -1102,17 +1102,17 @@ static void ar5523_tx(struct ieee80211_h
 	usb_fill_bulk_urb(urb, ar->dev, ar5523_data_tx_pipe(ar->dev),
 			  skb->data, skb->len, ar5523_data_tx_cb, skb);
 
+	spin_lock_irqsave(&ar->rx_data_list_lock, flags);
+	list_add_tail(&data->list, &ar->tx_data_list);
+	atomic_inc(&ar->tx_data_queued);
+	spin_unlock_irqrestore(&ar->rx_data_list_lock, flags);
+
 	error = usb_submit_urb(urb, GFP_ATOMIC);
 	if (error) {
 		ar5523_err(ar, "error %d when submitting tx urb\n", error);
 		goto out_free_urb;
 	}
 
-	spin_lock_irqsave(&ar->rx_data_list_lock, flags);
-	list_add_tail(&data->list, &ar->tx_data_list);
-	atomic_inc(&ar->tx_data_queued);
-	spin_unlock_irqrestore(&ar->rx_data_list_lock, flags);
-
 	return;
 
 out_free_urb:
